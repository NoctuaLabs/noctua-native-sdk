stages:
  - test
  - deploy
  - bump-version
  - release

.android:
  image: cimg/android:2024.07.1
  before_script:
    - cd android

test-android:
  extends: .android
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
      changes:
        - android/**
      when: always
  script:
    - ./gradlew check

deploy-gitlab-android-sdk:
  extends: .android
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - android/**
      when: always
  artifacts:
    paths:
      - sdk/build/outputs/aar/*.aar
  script:
    - ./gradlew :sdk:publishMavenPublicationToGitLabRepository
    - ./gradlew :sdk:publishToMavenCentral

bump-version-android-sdk:
  image:
    name: alpine/git
    entrypoint: [ "" ]
  stage: bump-version
  rules:
    - if: $CI_COMMIT_BRANCH == "release"
      when: always
  script:
    - apk add git-cliff
    - cd android
    - git-cliff --repository ".." --include-path "android/**/*" --bumped-version > version.txt
    - git add version.txt
    - git-cliff --repository ".." --include-path "android/**/*" --bump > CHANGELOG.md
    - git add CHANGELOG.md
    - git config --global user.email "gitlab-ci@noctua.gg"
    - git config --global user.name "Noctua Gitlab CI"
    - git commit -m "Bump version to v$(cat version.txt) [skip ci]"
    - git tag -a "v$(cat version.txt)" -m "Release v$(cat version.txt)"
    - git push "https://$GITLAB_BUILDER_USER:$GITLAB_BUILDER_ACCESS_TOKEN@gitlab.com/evosverse/noctua/noctua-sdk-native.git" HEAD:$CI_COMMIT_BRANCH --follow-tags -o ci.skip

release-android-sdk:
  extends: .android
  stage: release
  rules:
    - if: $CI_COMMIT_BRANCH == "release"
      when: manual
      needs:
        - bump-version-android-sdk
  script:
    - ./gradlew :sdk:publishAndReleaseToMavenCentral
