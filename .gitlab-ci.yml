stages:
  - test
  - deploy
  - release

.android:
  image: cimg/android:2024.07.1
  before_script:
    - cd android

test-android:
  extends: .android
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
      changes:
        - android/**
      when: always
  script:
    - ./gradlew check

deploy-gitlab-android-sdk:
  extends: .android
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - android/**
      when: always
  script:
    - ./gradlew :sdk:publishMavenPublicationToGitLabRepository

deploy-maven-central-android-sdk:
  extends: .android
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "release"
      when: always
  script:
    - ./gradlew :sdk:publishMavenPublicationToMavenCentralRepository

release-android-sdk:
  extends: .android
  stage: release
  rules:
    - if: $CI_COMMIT_BRANCH == "release"
      when: manual
      needs:
        - deploy-maven-central-android-sdk

  script:
    - ./gradlew :sdk:publishAndReleaseToMavenCentral
